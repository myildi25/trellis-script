name: Trellis Generator Auto-Run

on:
  # Manual trigger with auto-continue option
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to start processing'
        required: true
        default: 'no'
      auto_continue:
        description: 'Automatically continue if time limit reached?'
        required: true
        default: 'yes'
        type: choice
        options: [ 'yes', 'no' ]

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 360          # GitHub‚Äôs hard limit (safety)

    outputs:
      should_continue: ${{ steps.check-continue.outputs.should_continue }}

    steps:
    # ----------------------------------------------------------
    - name: Checkout code
      uses: actions/checkout@v3

    # ----------------------------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'     # OK for gradio_client 0.5.3

    # ----------------------------------------------------------
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_trellis.txt

    # ----------------------------------------------------------
    - name: Mask Trellis URL
      # Prevent accidental echoing of the credential‚Äëfilled URL
      run: echo "::add-mask::$TRELLIS_API_URL"
      env:
        TRELLIS_API_URL: ${{ secrets.TRELLIS_API_URL }}

    # ----------------------------------------------------------
    - name: Run Trellis Generator (5‚ÄØh‚ÄØ55‚ÄØm limit)
      if: ${{ github.event.inputs.confirm == 'yes' }}
      env:
        SUPABASE_URL:        ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY:${{ secrets.SUPABASE_SERVICE_KEY }}
        TRELLIS_API_URL:     ${{ secrets.TRELLIS_API_URL }}
      run: |
        echo "üöÄ Starting Trellis 3D Generation"
        echo "‚è∞ Will run for up to 5 hours 55 minutes"
        echo "This job started at: $(date)"

        # Run with graceful timeout (5‚ÄØh‚ÄØ55‚ÄØm = 21300‚ÄØs)
        timeout --signal=SIGTERM --kill-after=30s 21300 \
          python trellis_3d_generator_simple.py || EXIT_CODE=$?

        # Handle exit status
        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "‚è∞ Time limit reached ‚Äì¬†continuing in next run"
          echo "TIMEOUT_REACHED=true" >> $GITHUB_ENV
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "‚úÖ Processing completed successfully!"
          echo "TIMEOUT_REACHED=false" >> $GITHUB_ENV
        else
          echo "‚ùå Script failed with exit code ${EXIT_CODE:-0}"
          exit ${EXIT_CODE:-1}
        fi

    # ----------------------------------------------------------
    - name: Check if should continue
      id: check-continue
      run: |
        if [[ "${{ env.TIMEOUT_REACHED }}" == "true" ]] && \
           [[ "${{ github.event.inputs.auto_continue }}" == "yes" ]]; then
          echo
