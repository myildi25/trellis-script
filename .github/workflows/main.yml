name: Trellis Generator Autoâ€‘Run

###############################################################################
# â¶  Give the GITHUB_TOKEN â€œactions: writeâ€ so it can kick off the next run
###############################################################################
permissions:
  contents: read          # pull the code
  actions: write          # dispatch another workflow run

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to start processing'
        required: true
        default: 'no'
      auto_continue:
        description: 'Automatically continue if time limit reached?'
        required: true
        default: 'yes'
        type: choice
        options: [ 'yes', 'no' ]

###############################################################################
# â·  Keep only one run *per branch* at a time so loops donâ€™t collide
###############################################################################
concurrency:
  group: trellisâ€‘autorunâ€‘${{ github.ref }}
  cancel-in-progress: false   # let the current loop finish

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 360        # 6â€¯h safety cap

    outputs:
      should_continue: ${{ steps.check-continue.outputs.should_continue }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Pythonâ€¯3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_trellis.txt

    # â”€â”€ Mask secrets so they never appear in logs â”€â”€
    - name: Mask secrets
      run: |
        echo "::add-mask::$RUNPOD_USERNAME"
        echo "::add-mask::$RUNPOD_PASSWORD"
        echo "::add-mask::$TRELLIS_API_HOST"
        echo "::add-mask::$TRELLIS_API_URL"
      env:
        RUNPOD_USERNAME:  ${{ secrets.RUNPOD_USERNAME }}
        RUNPOD_PASSWORD:  ${{ secrets.RUNPOD_PASSWORD }}
        TRELLIS_API_HOST: ${{ secrets.TRELLIS_API_HOST }}
        TRELLIS_API_URL:  ${{ secrets.TRELLIS_API_URL }}

    # â”€â”€ Main run â”€â”€
    - name: Run Trellis Generator
      if: ${{ github.event.inputs.confirm == 'yes' }}
      env:
        SUPABASE_URL:         ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        TRELLIS_API_HOST:     ${{ secrets.TRELLIS_API_HOST }}
        TRELLIS_API_URL:      ${{ secrets.TRELLIS_API_URL }}
        RUNPOD_USERNAME:      ${{ secrets.RUNPOD_USERNAME }}
        RUNPOD_PASSWORD:      ${{ secrets.RUNPOD_PASSWORD }}
      run: |
        echo "ğŸš€ Starting Trellis 3D Generation"
        echo "â° Will run for up to 5â€¯hâ€¯55â€¯m"
        echo "Job started at: $(date)"

        timeout --signal=SIGTERM --kill-after=30s 21300 \
                python trellis_3d_generator_simple.py || EXIT_CODE=$?

        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "â° Time limit reached â€“ will continue in next run"
          echo "TIMEOUT_REACHED=true"  >> "$GITHUB_ENV"
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "âœ… Processing completed successfully"
          echo "TIMEOUT_REACHED=false" >> "$GITHUB_ENV"
        else
          echo "âŒ Script failed with exit code: ${EXIT_CODE:-0}"
          exit ${EXIT_CODE:-1}
        fi

    # â”€â”€ Decide whether to reâ€‘queue â”€â”€
    - name: Check if should continue
      id: check-continue
      run: |
        if [[ "${{ env.TIMEOUT_REACHED }}" == "true" && \
              "${{ github.event.inputs.auto_continue }}" == "yes" ]]; then
          echo "should_continue=true"  >> "$GITHUB_OUTPUT"
          echo "ğŸ“Š Another run will be triggered."
        else
          echo "should_continue=false" >> "$GITHUB_OUTPUT"
          echo "ğŸ Processing finished or autoâ€‘continue disabled."
        fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger-next-run:
    needs: generate
    if: ${{ needs.generate.outputs.should_continue == 'true' }}
    runs-on: ubuntu-latest

    steps:
    - name: Trigger next run
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OWNER_REPO:   ${{ github.repository }}
        WF_FILE:      trellis-autorun.yml
      run: |
        echo "ğŸ”„ Triggering followâ€‘up workflow runâ€¦"
        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          "https://api.github.com/repos/$OWNER_REPO/actions/workflows/$WF_FILE/dispatches" \
          -d "{
                \"ref\": \"${{ github.ref }}\",
                \"inputs\": {
                  \"confirm\":       \"yes\",
                  \"auto_continue\": \"${{ github.event.inputs.auto_continue }}\"
                }
              }"
        echo "âœ… Next run dispatched."
