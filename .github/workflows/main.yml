name: Trellis Generator Auto-Run

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to start processing'
        required: true
        default: 'no'
      auto_continue:
        description: 'Automatically continue if time limit reached?'
        required: true
        default: 'yes'
        type: choice
        options: [ 'yes', 'no' ]

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 360        # 6â€¯h safety cap

    outputs:
      should_continue: ${{ steps.check-continue.outputs.should_continue }}

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up PythonÂ 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_trellis.txt

    # â”€â”€ Mask secrets so they never leak to logs â”€â”€
    - name: Mask secrets
      run: |
        echo "::add-mask::$RUNPOD_USERNAME"
        echo "::add-mask::$RUNPOD_PASSWORD"
        echo "::add-mask::$TRELLIS_API_HOST"
      env:
        RUNPOD_USERNAME:  ${{ secrets.RUNPOD_USERNAME }}
        RUNPOD_PASSWORD:  ${{ secrets.RUNPOD_PASSWORD }}
        TRELLIS_API_HOST: ${{ secrets.TRELLIS_API_HOST }}

    # â”€â”€ Main run â”€â”€
    - name: Run Trellis Generator
      if: ${{ github.event.inputs.confirm == 'yes' }}
      env:
        SUPABASE_URL:         ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        TRELLIS_API_HOST:     ${{ secrets.TRELLIS_API_HOST }}   # host only, no creds
        RUNPOD_USERNAME:      ${{ secrets.RUNPOD_USERNAME }}
        RUNPOD_PASSWORD:      ${{ secrets.RUNPOD_PASSWORD }}
      run: |
        echo "ğŸš€ Starting Trellis 3D Generation"
        echo "â° Will run for up to 5â€¯hâ€¯55â€¯m"
        echo "Job started at: $(date)"

        # 5â€¯hâ€¯55â€¯m = 21â€¯300â€¯s
        timeout --signal=SIGTERM --kill-after=30s 21300 \
                python trellis_3d_generator_simple.py || EXIT_CODE=$?

        if [ "${EXIT_CODE:-0}" -eq 124 ]; then
          echo "â° Time limit reached â€“ will continue in next run"
          echo "TIMEOUT_REACHED=true"  >> $GITHUB_ENV
        elif [ "${EXIT_CODE:-0}" -eq 0 ]; then
          echo "âœ… Processing completed successfully"
          echo "TIMEOUT_REACHED=false" >> $GITHUB_ENV
        else
          echo "âŒ Script failed with exit code: ${EXIT_CODE:-0}"
          exit ${EXIT_CODE:-1}
        fi

    # â”€â”€ Decide whether to reâ€‘queue â”€â”€
    - name: Check if should continue
      id: check-continue
      run: |
        if [[ "${{ env.TIMEOUT_REACHED }}" == "true" && \
              "${{ github.event.inputs.auto_continue }}" == "yes" ]]; then
          echo "should_continue=true"  >> $GITHUB_OUTPUT
          echo "ğŸ“Š Another run will be triggered."
        else
          echo "should_continue=false" >> $GITHUB_OUTPUT
          echo "ğŸ Processing finished or auto-continue disabled."
        fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger-next-run:
    needs: generate
    if: ${{ needs.generate.outputs.should_continue == 'true' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Trigger next run
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ”„ Triggering followâ€‘up workflow run..."
        sleep 30   # avoid API rateâ€‘limit bursts

        curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/trellis-autorun.yml/dispatches" \
          -d '{
                "ref": "${{ github.ref }}",
                "inputs": {
                  "confirm":      "yes",
                  "auto_continue": "${{ github.event.inputs.auto_continue }}"
                }
              }'

        echo "âœ… Next run dispatched successfully."
